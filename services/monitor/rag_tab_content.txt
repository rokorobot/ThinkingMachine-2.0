# Add RAG tab content after line 154 (after Cognitive Engine tab)

RAG_TAB_CONTENT = """
# --- Tab 3: Knowledge Base (RAG) ---
with tabs[2]:
    st.header("ðŸ“š Knowledge Base & RAG System")
    
    # Top metrics
    col1, col2, col3, col4 = st.columns(4)
    
    # Total documents
    docs_count_df = get_data("SELECT COUNT(*) as c FROM knowledge_documents")
    docs_count = docs_count_df.iloc[0]['c'] if not docs_count_df.empty else 0
    col1.metric("Total Documents", docs_count)
    
    # Total chunks
    chunks_count_df = get_data("SELECT COUNT(*) as c FROM knowledge_chunks")
    chunks_count = chunks_count_df.iloc[0]['c'] if not chunks_count_df.empty else 0
    col2.metric("Total Chunks", chunks_count)
    
    # RAG usage (24h)
    rag_usage = get_data(\"\"\"
        SELECT COUNT(*) as c 
        FROM traces 
        WHERE created_at > NOW() - INTERVAL '24 hours'
        AND (metadata->>'rag_used')::boolean = TRUE
    \"\"\")
    rag_count = rag_usage.iloc[0]['c'] if not rag_usage.empty else 0
    col3.metric("RAG Queries (24h)", rag_count)
    
    # Avg snippets per query
    avg_snippets = get_data(\"\"\"
        SELECT AVG((metadata->>'rag_snippet_count')::int) as avg
        FROM traces 
        WHERE created_at > NOW() - INTERVAL '24 hours'
        AND (metadata->>'rag_used')::boolean = TRUE
    \"\"\")
    avg_snip = avg_snippets.iloc[0]['avg'] if not avg_snippets.empty and pd.notnull(avg_snippets.iloc[0]['avg']) else 0
    col4.metric("Avg Snippets/Query", f"{avg_snip:.1f}")
    
    st.divider()
    
    # Document sources breakdown
    col_left, col_right = st.columns(2)
    
    with col_left:
        st.subheader("Documents by Source")
        sources_df = get_data(\"\"\"
            SELECT source, COUNT(*) as count 
            FROM knowledge_documents 
            GROUP BY source 
            ORDER BY count DESC
        \"\"\")
        if not sources_df.empty:
            fig = px.pie(sources_df, values='count', names='source', title='Document Sources')
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.info("No documents ingested yet.")
    
    with col_right:
        st.subheader("Recent Ingestions")
        recent_docs = get_data(\"\"\"
            SELECT title, source, doc_type, created_at
            FROM knowledge_documents 
            ORDER BY created_at DESC 
            LIMIT 10
        \"\"\")
        st.dataframe(recent_docs, use_container_width=True)
    
    st.divider()
    
    # RAG Activity Over Time
    st.subheader("RAG Usage Over Time (Last 7 Days)")
    rag_timeline = get_data(\"\"\"
        SELECT 
            DATE_TRUNC('day', created_at) as day,
            COUNT(*) as total_queries,
            SUM(CASE WHEN (metadata->>'rag_used')::boolean = TRUE THEN 1 ELSE 0 END) as rag_queries
        FROM traces 
        WHERE created_at > NOW() - INTERVAL '7 days'
        GROUP BY 1
        ORDER BY 1
    \"\"\")
    if not rag_timeline.empty:
        fig = go.Figure()
        fig.add_trace(go.Scatter(x=rag_timeline['day'], y=rag_timeline['total_queries'], 
                                 mode='lines+markers', name='Total Queries'))
        fig.add_trace(go.Scatter(x=rag_timeline['day'], y=rag_timeline['rag_queries'], 
                                 mode='lines+markers', name='RAG Queries'))
        fig.update_layout(title='Query Volume', xaxis_title='Date', yaxis_title='Count')
        st.plotly_chart(fig, use_container_width=True)
    
    st.divider()
    
    # Recent RAG retrievals
    st.subheader("Recent RAG Retrievals")
    recent_rag = get_data(\"\"\"
        SELECT 
            input_text,
            (metadata->>'rag_snippet_count')::int as snippet_count,
            created_at
        FROM traces 
        WHERE (metadata->>'rag_used')::boolean = TRUE
        ORDER BY created_at DESC 
        LIMIT 5
    \"\"\")
    if not recent_rag.empty:
        for _, row in recent_rag.iterrows():
            with st.expander(f"[{row['created_at']}] {row['input_text'][:60]}... ({row['snippet_count']} snippets)"):
                st.write(f"**Query:** {row['input_text']}")
                st.write(f"**Snippets Retrieved:** {row['snippet_count']}")
    else:
        st.info("No RAG queries yet.")
"""
